# Техническое задание: Система мини-АТС

## Общее описание проекта
Клиент-серверная система симуляции телефонной мини-АТС на C# с WPF интерфейсом. Сервер управляет подключениями абонентов и маршрутизацией вызовов. Множество клиентов (WPF приложений) подключаются к серверу, каждый клиент представляет отдельного абонента.

**Ключевые технологии:** C#, WPF, TCP сокеты

---

## Задача 1: Конфигурационный файл сервера

### Описание
Создать JSON конфигурационный файл для сервера с параметрами системы.

### Требования
- Файл `config.json` в корне серверного проекта
- Параметры:
  - `MaxConnections` (int) — максимальное количество одновременных соединений (по умолчанию 4)
  - `PhoneNumberLength` (int) — длина телефонного номера в цифрах (по умолчанию 3)
  - `ServerPort` (int) — порт TCP сервера (по умолчанию 5000)

### Критерии приёмки
- [x] Файл config.json существует
- [x] Все три параметра присутствуют
- [x] Значения имеют корректный тип данных
- [x] Файл валидный JSON

---

## Задача 2: Enum состояний абонента

### Описание
Создать перечисление состояний абонента согласно жизненному циклу.

### Требования
Enum `SubscriberState` с состояниями:
- `Idle` — ожидание (трубка положена)
- `Ready` — готов к набору (трубка снята, есть свободные линии)
- `Busy` — занято (трубка снята, нет свободных линий)
- `Dialing` — набор номера (трубка снята, набирает номер)
- `Ringing` — входящий вызов (кто-то звонит этому абоненту)
- `InCall` — в разговоре (соединение установлено)

### Критерии приёмки
- [x] Enum содержит все 6 состояний
- [x] Используется в классе Subscriber
- [x] Названия состояний соответствуют спецификации

---

## Задача 3: Класс Subscriber (модель абонента на сервере)

### Описание
Класс представляет абонента на стороне сервера.

### Требования
**Свойства:**
- `PhoneNumber` (string, readonly) — номер телефона
- `State` (SubscriberState) — текущее состояние
- `CurrentConnection` (Connection, nullable) — текущее соединение (если есть)
- `ClientHandler` (ClientHandler) — обработчик клиентского подключения

**Методы:**
- `ChangeState(SubscriberState newState)` — изменить состояние
- `CanMakeCall()` — проверка возможности совершить вызов (состояние Ready или Dialing)
- `CanReceiveCall()` — проверка возможности принять вызов (состояние Idle)

### Критерии приёмки
- [x] Класс содержит все указанные свойства
- [x] Методы реализованы согласно логике состояний
- [x] PhoneNumber устанавливается только через конструктор
- [x] State изменяется только через ChangeState()

---

## Задача 4: Класс Connection (соединение двух абонентов)

### Описание
Класс представляет активное соединение между двумя абонентами.

### Требования
**Свойства:**
- `SubscriberA` (Subscriber, readonly) — первый абонент
- `SubscriberB` (Subscriber, readonly) — второй абонент
- `EstablishedAt` (DateTime, readonly) — время установления соединения

**Методы:**
- `SendMessage(Subscriber from, string message)` — отправить сообщение от одного абонента другому
- `GetOtherSubscriber(Subscriber subscriber)` — получить второго участника соединения
- `Disconnect()` — разорвать соединение

### Критерии приёмки
- [x] Класс содержит все указанные свойства
- [x] SendMessage корректно определяет получателя
- [x] GetOtherSubscriber возвращает правильного абонента
- [x] Disconnect изменяет состояния обоих абонентов на Idle

---

## Задача 5: Класс ClientHandler (обработчик клиентского подключения)

### Описание
Класс управляет TCP соединением с одним клиентом и обрабатывает его команды.

### Требования
**Свойства:**
- `TcpClient` (TcpClient) — TCP клиент
- `NetworkStream` (NetworkStream) — поток данных
- `Subscriber` (Subscriber) — связанный абонент

**Методы:**
- `StartListening()` — начать прослушивание команд в отдельном потоке
- `SendMessage(string message)` — отправить сообщение клиенту
- `ProcessCommand(string command)` — обработать команду от клиента
- `Disconnect()` — закрыть соединение

**Обрабатываемые команды от клиента:**
- `CONNECT` — запрос подключения
- `PICKUP` — снял трубку
- `HANGUP` — положил трубку
- `DIAL:<номер>` — набрал номер
- `MESSAGE:<текст>` — отправил сообщение

### Критерии приёмки
- [x] StartListening запускает асинхронное чтение в отдельном потоке
- [x] SendMessage корректно отправляет данные через NetworkStream
- [x] ProcessCommand парсит и обрабатывает все 5 типов команд
- [x] Disconnect корректно закрывает ресурсы
- [x] Обработка ошибок сети (try-catch)

---

## Задача 6: Класс MiniATS (ядро системы)

### Описание
Главный класс сервера, управляющий всеми абонентами и соединениями.

### Требования
**Свойства:**
- `MaxConnections` (int, readonly) — лимит одновременных соединений
- `PhoneNumberLength` (int, readonly) — длина номера телефона
- `Subscribers` (List<Subscriber>) — список подключенных абонентов
- `ActiveConnections` (List<Connection>) — список активных соединений
- `NextPhoneNumber` (int) — счётчик для генерации номеров

**Методы:**
- `LoadConfig(string configPath)` — загрузить конфигурацию из JSON
- `GeneratePhoneNumber()` — сгенерировать уникальный номер
- `RegisterSubscriber(ClientHandler handler)` — зарегистрировать нового абонента
- `UnregisterSubscriber(Subscriber subscriber)` — отключить абонента
- `HandlePickup(Subscriber subscriber)` — обработать снятие трубки
- `HandleDial(Subscriber caller, string targetNumber)` — обработать набор номера
- `HandleHangup(Subscriber subscriber)` — обработать положение трубки
- `HandleMessage(Subscriber sender, string message)` — обработать сообщение
- `CanCreateConnection()` — проверка доступности линий
- `CreateConnection(Subscriber a, Subscriber b)` — создать соединение
- `RemoveConnection(Connection connection)` — удалить соединение
- `BroadcastSubscribersList()` — отправить всем клиентам список абонентов

### Критерии приёмки
- [x] LoadConfig корректно парсит JSON и устанавливает параметры
- [x] GeneratePhoneNumber создаёт номера заданной длины
- [x] HandlePickup проверяет лимит соединений и отправляет сигнал
- [x] HandleDial проверяет существование и доступность номера
- [x] HandleHangup корректно разрывает соединение
- [x] HandleMessage пересылает сообщение через Connection
- [x] BroadcastSubscribersList отправляет актуальную информацию после каждого изменения

---

## Задача 7: TCP сервер (точка входа)

### Описание
Консольное приложение сервера с TCP listener.

### Требования
`Program.cs` с методом Main:
- Создать экземпляр MiniATS
- Загрузить конфигурацию
- Запустить TcpListener на порту из конфигурации
- В бесконечном цикле принимать подключения
- Для каждого подключения создавать ClientHandler и регистрировать в MiniATS

**Логирование в консоль:**
- "Сервер запущен на порту {port}"
- "Подключился клиент {IP}"
- "Абоненту присвоен номер {number}"
- "Соединение установлено: {number1} <-> {number2}"
- "Соединение разорвано: {number1} <-> {number2}"
- "Клиент отключился {number}"

### Критерии приёмки
- [x] Сервер успешно запускается и слушает указанный порт
- [x] Принимает множественные подключения
- [x] Каждое подключение обрабатывается в отдельном потоке
- [x] Логирование работает корректно
- [x] Graceful shutdown (Ctrl+C закрывает все соединения)

---

## Задача 8: Протокол сообщений сервер → клиент

### Описание
Определить формат сообщений, которые сервер отправляет клиенту.

### Требования
Сообщения (каждое на отдельной строке, разделитель `\n`):
1. `ASSIGNED:<номер>` — присвоен номер телефона
2. `SIGNAL:готов` — сигнал "готов к набору"
3. `SIGNAL:занято` — сигнал "все линии заняты"
4. `STATE:<состояние>` — изменение собственного состояния
5. `INCOMING_CALL:<номер>` — входящий вызов от указанного номера
6. `CALL_CONNECTED` — соединение установлено
7. `CALL_ENDED` — соединение разорвано
8. `MESSAGE:<текст>` — входящее сообщение от собеседника
9. `SUBSCRIBERS:<json>` — список всех абонентов с состояниями
10. `ERROR:<текст>` — сообщение об ошибке

### Критерии приёмки
- [x] Все 10 типов сообщений документированы
- [x] Формат однозначно определён
- [x] Используются в реализации ClientHandler.SendMessage()

---

## Задача 9: WPF клиент — структура окна

### Описание
Создать WPF приложение с единственным окном MainWindow, разделённым на 4 панели.

### Требования
MainWindow содержит:

**Панель параметров (верхняя):**
- Label: "Адрес сервера:"
- TextBox: IP:Port (по умолчанию "127.0.0.1:5000")
- Button: "Подключиться" / "Отключиться"
- Label: "Мой номер:" + TextBlock с присвоенным номером
- Label: "Статус:" + TextBlock со статусом подключения

**Панель управления (левая):**
- Button: "Снять трубку"
- Button: "Положить трубку"
- Label: "Набрать номер:"
- TextBox: ввод номера
- Button: "Позвонить"
- Label: "Сигнал:" + TextBlock

**Панель чата (центральная):**
- TextBox (многострочный, read-only): история сообщений
- TextBox (однострочный): поле ввода сообщения
- Button: "Отправить"
- Label: "Чат" (заголовок)

**Панель статуса (правая):**
- Label: "Моё состояние:" + TextBlock с текущим состоянием
- Label: "Абоненты в сети:"
- ListBox: список абонентов

### Критерии приёмки
- [x] Окно содержит все 4 панели с указанными элементами
- [x] Панели логически разделены
- [x] Элементы управления имеют осмысленные имена
- [x] Интерфейс адаптивный
- [x] Начальное состояние: кнопки неактивны до подключения

---

## Задача 10: WPF клиент — класс PhoneClient

### Описание
Класс для TCP подключения к серверу и обмена сообщениями.

### Требования
**Свойства:**
- `TcpClient` — TCP клиент
- `NetworkStream` — поток данных
- `IsConnected` (bool) — статус подключения

**События:**
- `OnAssignedNumber(string number)` — присвоен номер
- `OnSignalReceived(string signal)` — получен сигнал
- `OnStateChanged(string state)` — изменилось состояние
- `OnIncomingCall(string number)` — входящий вызов
- `OnCallConnected()` — соединение установлено
- `OnCallEnded()` — соединение разорвано
- `OnMessageReceived(string message)` — получено сообщение
- `OnSubscribersListReceived(List<SubscriberInfo>)` — обновлён список
- `OnDisconnected()` — отключение от сервера
- `OnError(string error)` — ошибка

**Методы:**
- `Connect(string serverAddress, int port)` — подключиться
- `Disconnect()` — отключиться
- `SendPickup()` — отправить PICKUP
- `SendHangup()` — отправить HANGUP
- `SendDial(string number)` — отправить DIAL
- `SendMessage(string message)` — отправить MESSAGE
- `StartListening()` — начать прослушивание

### Критерии приёмки
- [x] Connect устанавливает TCP соединение и отправляет CONNECT
- [x] StartListening читает сообщения в отдельном потоке
- [x] Парсинг всех 10 типов сообщений от сервера
- [x] События корректно вызываются
- [x] Обработка ошибок сети
- [x] Disconnect корректно закрывает соединение

---

## Задача 11: WPF клиент — логика MainWindow

### Описание
Реализовать логику взаимодействия пользователя с интерфейсом через PhoneClient.

### Требования
**Подключение/отключение:**
- Кнопка "Подключиться" вызывает PhoneClient.Connect()
- При успешном подключении кнопка меняется на "Отключиться"
- При получении номера отображается в "Мой номер"

**Управление трубкой:**
- "Снять трубку" активна только в состоянии Idle или Ringing
- "Положить трубку" активна в состояниях Ready, Ringing, InCall, Dialing, Busy

**Набор номера:**
- "Позвонить" активна только в состоянии Ready

**Сигналы:**
- OnSignalReceived обновляет TextBlock "Сигнал"

**Состояния:**
- OnStateChanged обновляет TextBlock и управляет доступностью кнопок

**Входящие вызовы:**
- OnIncomingCall отображает MessageBox

**Чат:**
- OnCallConnected очищает историю, активирует поле ввода
- OnMessageReceived добавляет сообщение в историю
- "Отправить" вызывает PhoneClient.SendMessage()
- OnCallEnded очищает чат, деактивирует поле ввода

**Список абонентов:**
- OnSubscribersListReceived обновляет ListBox

### Критерии приёмки
- [x] Все кнопки активны/неактивны в соответствии с состоянием
- [x] Все события PhoneClient обработаны
- [x] UI обновляется через Dispatcher
- [x] Чат корректно отображает историю
- [x] Список абонентов обновляется
- [x] Входящий вызов отображается пользователю

---

## Задача 12: Сценарий "Успешный вызов"

### Описание
Интеграционное тестирование полного цикла вызова.

### Сценарий
1. Запустить сервер
2. Запустить клиент A, подключиться (получить номер 001)
3. Запустить клиент B, подключиться (получить номер 002)
4. Клиент A: снять трубку → получить сигнал "Готов"
5. Клиент A: набрать номер 002 и позвонить
6. Клиент B: получить уведомление "Входящий вызов от 001", состояние Ringing
7. Клиент B: снять трубку
8. Оба клиента: состояние InCall, чат активен
9. Клиент A: отправить сообщение "Привет"
10. Клиент B: получить и отобразить "Собеседник: Привет"
11. Клиент B: отправить сообщение "Привет!"
12. Клиент A: получить и отобразить "Собеседник: Привет!"
13. Клиент A: положить трубку
14. Оба клиента: состояние Idle, чат очищен

### Критерии приёмки
- [ ] Все шаги выполнены без ошибок
- [ ] Состояния клиентов соответствуют сценарию
- [ ] Сообщения доставлены и отображены корректно
- [ ] После разрыва оба клиента вернулись в Idle

---

## Задача 13: Сценарий "Лимит соединений"

### Описание
Тестирование лимита одновременных соединений (MaxConnections = 4).

### Сценарий
1. Запустить сервер с MaxConnections = 4
2. Подключить клиентов A (001), B (002), C (003), D (004), E (005), F (006), G (007), H (008), I (009)
3. A → B: соединение 1
4. C → D: соединение 2
5. E → F: соединение 3
6. G → H: соединение 4
7. I снимает трубку → получает сигнал "Занято"
8. I не может позвонить
9. A кладёт трубку → соединение 1 разорвано
10. I снимает трубку → получает сигнал "Готов"
11. I → A: соединение 5 успешно

### Критерии приёмки
- [ ] Сервер отклоняет снятие трубки при достижении лимита
- [ ] Клиент получает сигнал "Занято"
- [ ] После освобождения линии следующий абонент может совершить вызов
- [ ] Счётчик активных соединений работает корректно

---

## Задача 14: Сценарий "Вызов несуществующего номера"

### Описание
Тестирование обработки ошибок при наборе несуществующего номера.

### Сценарий
1. Подключить клиента A (001)
2. A снимает трубку, набирает номер 999 (не существует)
3. Сервер отправляет ERROR:Номер не найден
4. Клиент отображает MessageBox с ошибкой
5. Клиент остаётся в состоянии Ready

### Критерии приёмки
- [ ] Сервер проверяет существование номера
- [ ] Клиент получает сообщение об ошибке
- [ ] Состояние клиента не меняется
- [ ] Пользователь информирован об ошибке

---

## Задача 15: Сценарий "Вызов занятого абонента"

### Описание
Тестирование попытки вызвать абонента, который уже разговаривает.

### Сценарий
1. Подключить A (001), B (002), C (003)
2. A → B: соединение установлено, оба в состоянии InCall
3. C снимает трубку, набирает 001
4. Сервер отклоняет вызов (A занят)
5. C получает ERROR:Абонент занят
6. C остаётся в состоянии Ready

### Критерии приёмки
- [ ] Сервер проверяет состояние вызываемого абонента
- [ ] Вызов занятого абонента отклоняется
- [ ] Клиент получает сообщение об ошибке
- [ ] Состояние вызывающего не меняется

---

## Задача 16: ER-диаграмма (сущность-связь)

### Описание
Создать ER-диаграмму модели предметной области.

### Требования
**Сущности:**
- Абонент (Subscriber): Номер телефона (PK), Состояние, IP-адрес клиента
- Соединение (Connection): ID (PK), Время установления
- АТС (MiniATS): Максимум соединений, Длина номера, Порт

**Связи:**
- АТС управляет Абонентами (1:N)
- АТС управляет Соединениями (1:N)
- Соединение связывает двух Абонентов (1:2)

### Критерии приёмки
- [ ] Диаграмма содержит все 3 сущности
- [ ] Указаны ключевые атрибуты
- [ ] Связи отражают реальную структуру системы
- [ ] Кардинальность связей указана корректно

---

## Задача 17: UML диаграмма классов

### Описание
Создать полную диаграмму классов системы.

### Требования
**Классы сервера:**
- MiniATS
- Subscriber
- Connection
- ClientHandler
- SubscriberState (enum)

**Классы клиента:**
- MainWindow
- PhoneClient
- SubscriberInfo

**Связи:**
- MiniATS содержит коллекцию Subscriber (композиция 1:*)
- MiniATS содержит коллекцию Connection (композиция 1:*)
- Subscriber использует SubscriberState (зависимость)
- Subscriber связан с ClientHandler (ассоциация 1:1)
- Subscriber связан с Connection (ассоциация 0..1)
- Connection связан с двумя Subscriber (ассоциация 2)
- MainWindow использует PhoneClient (композиция 1:1)

### Критерии приёмки
- [ ] Диаграмма содержит все классы обеих подсистем
- [ ] Указаны атрибуты и методы классов
- [ ] Типы связей указаны корректно
- [ ] Кардинальность связей указана
- [ ] Диаграмма читаема и структурирована

---

## Задача 18: Диаграмма последовательности

### Описание
Создать диаграмму последовательности для сценария успешного вызова.

### Требования
Участники:
- Клиент A
- Сервер (MiniATS)
- Клиент B

Последовательность:
1. A → Сервер: PICKUP
2. Сервер → A: SIGNAL:готов, STATE:Ready
3. A → Сервер: DIAL:002
4. Сервер → B: INCOMING_CALL:001, STATE:Ringing
5. B → Сервер: PICKUP
6. Сервер → A: CALL_CONNECTED, STATE:InCall
7. Сервер → B: CALL_CONNECTED, STATE:InCall
8. A → Сервер: MESSAGE:Привет
9. Сервер → B: MESSAGE:Привет
10. A → Сервер: HANGUP
11. Сервер → A: CALL_ENDED, STATE:Idle
12. Сервер → B: CALL_ENDED, STATE:Idle

### Критерии приёмки
- [ ] Диаграмма отражает полный цикл вызова
- [ ] Все сообщения указаны корректно
- [ ] Порядок взаимодействия соответствует реализации

---

## Задача 19: Документация к проекту

### Описание
Создать документ с описанием архитектуры и инструкцией по запуску.

### Требования
Документ должен содержать:
- Описание системы
- Структура проекта
- Протокол обмена сообщениями
- Инструкция по запуску
- Диаграммы (ER, классов, последовательности)

### Критерии приёмки
- [ ] Документ содержит все разделы
- [ ] Инструкции чёткие и выполнимые
- [ ] Диаграммы встроены в документ
- [ ] Формат: PDF или Markdown
- [ ] Объём: 10-15 страниц
