# Документация: Система АТС

## 1. Описание системы

### 1.1 Назначение
Система АТС представляет собой клиент-серверное приложение для симуляции работы телефонной станции. Система позволяет множеству абонентов подключаться к серверу, совершать и принимать вызовы, а также обмениваться текстовыми сообщениями во время разговора.

### 1.2 Архитектура
Система построена по архитектуре клиент-сервер:
- **Сервер** — консольное приложение на C#, управляющее подключениями абонентов и маршрутизацией вызовов
- **Клиент** — WPF приложение с графическим интерфейсом, представляющее отдельного абонента

Взаимодействие между клиентом и сервером осуществляется по протоколу TCP с использованием текстовых команд.

### 1.3 Используемые технологии
- **Язык программирования:** C# (.NET 9.0)
- **Клиентский интерфейс:** WPF (Windows Presentation Foundation)
- **Сетевое взаимодействие:** TCP Sockets
- **Формат данных:** JSON (для конфигурации и передачи списков)
- **Многопоточность:** async/await, Task

### 1.4 Параметры системы
- **Количество абонентов:** 7 (2N-1, где N=4)
- **Лимит соединений:** 4 одновременных соединения (2K, где K=2)
- **Длина телефонного номера:** 3 цифры (001-999)
- **Порт сервера:** 5000 (по умолчанию)

---

## 2. Структура проекта

### 2.1 Решение (Solution)
```
TelephoneExchange.sln
├── TelephoneExchange.Server/    # Серверное приложение
└── TelephoneExchange.Client/    # Клиентское приложение
```

### 2.2 Серверный проект (TelephoneExchange.Server)
```
TelephoneExchange.Server/
├── Models/
│   ├── Subscriber.cs           # Модель абонента
│   ├── SubscriberState.cs      # Перечисление состояний
│   └── Connection.cs           # Модель соединения
├── Network/
│   ├── ATS.cs             # Ядро системы АТС
│   └── ClientHandler.cs       # Обработчик клиентского подключения
├── Program.cs                  # Точка входа сервера
└── config.json                 # Конфигурационный файл
```

### 2.3 Клиентский проект (TelephoneExchange.Client)
```
TelephoneExchange.Client/
├── Models/
│   └── SubscriberInfo.cs      # Информация об абоненте
├── Network/
│   └── PhoneClient.cs         # Клиент для связи с сервером
├── MainWindow.xaml            # Разметка главного окна
├── MainWindow.xaml.cs         # Логика главного окна
└── App.xaml                   # Конфигурация приложения
```

---

## 3. Основные классы и их назначение

### 3.1 Серверная часть

#### ATS
Центральный класс сервера, управляющий всеми абонентами и соединениями.

**Основные методы:**
- `LoadConfig()` — загрузка конфигурации из JSON
- `RegisterSubscriber()` — регистрация нового абонента
- `HandlePickup()` — обработка снятия трубки
- `HandleDial()` — обработка набора номера
- `HandleHangup()` — обработка положения трубки
- `BroadcastSubscribersList()` — рассылка списка абонентов всем клиентам

#### Subscriber
Представляет абонента на стороне сервера.

**Свойства:**
- `PhoneNumber` — номер телефона
- `State` — текущее состояние (Idle, Ready, Busy, Dialing, Ringing, InCall)
- `CurrentConnection` — текущее соединение (если есть)

#### Connection
Представляет активное соединение между двумя абонентами.

**Методы:**
- `SendMessage()` — отправка сообщения от одного абонента другому
- `Disconnect()` — разрыв соединения

#### ClientHandler
Управляет TCP соединением с одним клиентом.

**Методы:**
- `StartListening()` — прослушивание команд от клиента
- `SendMessage()` — отправка сообщения клиенту
- `ProcessCommand()` — обработка команд (CONNECT, PICKUP, HANGUP, DIAL, MESSAGE)

### 3.2 Клиентская часть

#### PhoneClient
Класс для TCP подключения к серверу и обмена сообщениями.

**События:**
- `OnAssignedNumber` — присвоен номер телефона
- `OnStateChanged` — изменилось состояние
- `OnIncomingCall` — входящий вызов
- `OnCallConnected` — соединение установлено
- `OnMessageReceived` — получено сообщение

**Методы:**
- `Connect()` — подключение к серверу
- `SendPickup()` — отправка команды "снять трубку"
- `SendDial()` — отправка команды "набрать номер"
- `SendMessage()` — отправка текстового сообщения

#### MainWindow
Главное окно WPF приложения с пользовательским интерфейсом.

**Панели интерфейса:**
- Панель параметров (подключение к серверу)
- Панель управления (снять/положить трубку, набор номера)
- Панель чата (обмен сообщениями)
- Панель статуса (состояние, список абонентов)

---

## 4. Протокол обмена сообщениями

### 4.1 Команды клиент → сервер

| Команда | Описание | Пример |
|---------|----------|--------|
| `CONNECT` | Запрос подключения к серверу | `CONNECT` |
| `PICKUP` | Снять трубку | `PICKUP` |
| `HANGUP` | Положить трубку | `HANGUP` |
| `DIAL:<номер>` | Набрать номер | `DIAL:002` |
| `MESSAGE:<текст>` | Отправить сообщение | `MESSAGE:Привет` |

### 4.2 Сообщения сервер → клиент

| Сообщение | Описание | Пример |
|-----------|----------|--------|
| `ASSIGNED:<номер>` | Присвоен номер телефона | `ASSIGNED:001` |
| `SIGNAL:готов` | Сигнал "готов к набору" | `SIGNAL:готов` |
| `SIGNAL:занято` | Сигнал "все линии заняты" | `SIGNAL:занято` |
| `STATE:<состояние>` | Изменение состояния | `STATE:InCall` |
| `INCOMING_CALL:<номер>` | Входящий вызов | `INCOMING_CALL:001` |
| `CALL_CONNECTED` | Соединение установлено | `CALL_CONNECTED` |
| `CALL_ENDED` | Соединение разорвано | `CALL_ENDED` |
| `MESSAGE:<текст>` | Входящее сообщение | `MESSAGE:Привет` |
| `SUBSCRIBERS:<json>` | Список абонентов | `SUBSCRIBERS:[{"number":"001","state":"Idle"}]` |
| `ERROR:<текст>` | Сообщение об ошибке | `ERROR:Номер не найден` |

### 4.3 Формат передачи
- Каждое сообщение завершается символом перевода строки `\n`
- Кодировка: UTF-8
- Сообщения обрабатываются асинхронно в отдельных потоках

---

## 5. Состояния абонента

### 5.1 Диаграмма состояний

```
┌─────────┐
│  Idle   │ ◄─────────────────────────┐
└────┬────┘                           │
     │ PICKUP (есть линии)            │
     ▼                                │
┌─────────┐                           │
│  Ready  │                           │
└────┬────┘                           │
     │ DIAL:<номер>                   │
     ▼                                │
┌──────────┐                          │
│ Dialing  │                          │
└──────────┘                          │
                                      │
┌──────────┐                          │
│ Ringing  │ ◄─── Входящий вызов      │
└────┬─────┘                          │
     │ PICKUP                         │
     ▼                                │
┌─────────┐                           │
│ InCall  │ ──── HANGUP ──────────────┘
└─────────┘

┌─────────┐
│  Busy   │ ◄─── PICKUP (нет линий)
└─────────┘
     │ HANGUP
     ▼
┌─────────┐
│  Idle   │
└─────────┘
```

### 5.2 Описание состояний

- **Idle** — ожидание (трубка положена)
- **Ready** — готов к набору (трубка снята, есть свободные линии)
- **Busy** — занято (трубка снята, нет свободных линий)
- **Dialing** — набор номера (вызывает другого абонента)
- **Ringing** — входящий вызов (кто-то звонит этому абоненту)
- **InCall** — в разговоре (соединение установлено)

---

## 6. Инструкция по запуску

### 6.1 Требования
- .NET 9.0 SDK или выше
- Windows (для WPF клиента)
- Свободный порт 5000 (или другой, указанный в конфигурации)

### 6.2 Настройка конфигурации

Отредактируйте файл `TelephoneExchange.Server/config.json`:

```json
{
  "MaxConnections": 4,
  "PhoneNumberLength": 3,
  "ServerPort": 5000
}
```

**Параметры:**
- `MaxConnections` — максимальное количество одновременных соединений
- `PhoneNumberLength` — длина телефонного номера (количество цифр)
- `ServerPort` — порт TCP сервера

### 6.3 Запуск сервера

1. Откройте терминал в корне проекта
2. Выполните команду:
```bash
dotnet run --project TelephoneExchange.Server/TelephoneExchange.Server.csproj
```

3. Дождитесь сообщения:
```
=== АТС Сервер ===
Конфигурация загружена: MaxConnections=4, PhoneNumberLength=3
Сервер запущен на порту 5000
Ожидание подключений...
```

### 6.4 Запуск клиента

1. Откройте новый терминал в корне проекта
2. Выполните команду:
```bash
dotnet run --project TelephoneExchange.Client/TelephoneExchange.Client.csproj
```

3. В открывшемся окне:
   - Убедитесь, что адрес сервера указан правильно (по умолчанию `127.0.0.1:5000`)
   - Нажмите кнопку "Подключиться"
   - После успешного подключения вам будет присвоен номер телефона

4. Для тестирования запустите несколько экземпляров клиента (повторите шаги 1-3)

### 6.5 Сборка проекта

Для сборки всего решения:
```bash
dotnet build TelephoneExchange.sln
```

Для сборки только сервера:
```bash
dotnet build TelephoneExchange.Server/TelephoneExchange.Server.csproj
```

Для сборки только клиента:
```bash
dotnet build TelephoneExchange.Client/TelephoneExchange.Client.csproj
```

---

## 7. Примеры использования

### 7.1 Сценарий: Успешный вызов

1. **Запустите сервер**
2. **Запустите клиент A** и подключитесь (получите номер 001)
3. **Запустите клиент B** и подключитесь (получите номер 002)
4. **В клиенте A:**
   - Нажмите "Снять трубку"
   - Вы увидите сигнал "Готов"
   - Введите номер "002" в поле "Набрать номер"
   - Нажмите "Позвонить"
5. **В клиенте B:**
   - Появится уведомление "Входящий вызов от 001"
   - Нажмите "Снять трубку"
6. **Оба клиента:**
   - Состояние изменится на "InCall"
   - Чат станет активным
7. **Обмен сообщениями:**
   - В клиенте A введите "Привет" и нажмите "Отправить"
   - В клиенте B появится "Собеседник: Привет"
   - В клиенте B введите "Привет!" и нажмите "Отправить"
   - В клиенте A появится "Собеседник: Привет!"
8. **Завершение вызова:**
   - В любом из клиентов нажмите "Положить трубку"
   - Оба клиента вернутся в состояние "Idle"
   - Чат очистится и деактивируется

### 7.2 Сценарий: Лимит соединений

1. **Запустите сервер** с MaxConnections = 4
2. **Подключите 9 клиентов** (001-009)
3. **Установите 4 соединения:**
   - 001 → 002
   - 003 → 004
   - 005 → 006
   - 007 → 008
4. **В клиенте 009:**
   - Нажмите "Снять трубку"
   - Вы увидите сигнал "Занято"
   - Кнопка "Позвонить" будет неактивна
5. **В клиенте 001:**
   - Нажмите "Положить трубку"
   - Соединение 001-002 разорвано
6. **В клиенте 009:**
   - Нажмите "Снять трубку"
   - Теперь вы увидите сигнал "Готов"
   - Можете совершить вызов

### 7.3 Сценарий: Обработка ошибок

**Вызов несуществующего номера:**
1. Подключитесь к серверу
2. Снимите трубку
3. Введите номер "999" (не существует)
4. Нажмите "Позвонить"
5. Появится сообщение об ошибке "Номер не найден"
6. Вы останетесь в состоянии "Ready"

**Вызов занятого абонента:**
1. Установите соединение между клиентами A и B
2. В клиенте C снимите трубку
3. Наберите номер клиента A
4. Появится сообщение об ошибке "Абонент занят"
5. Вы останетесь в состоянии "Ready"

---

## 8. Диаграммы

### 8.1 ER-диаграмма
См. файл `docs/diagrams/er-diagram.puml`

Основные сущности:
- **АТС (ATS)** — управляет абонентами и соединениями
- **Абонент (Subscriber)** — представляет подключенного клиента
- **Соединение (Connection)** — связывает двух абонентов

### 8.2 Диаграмма классов
См. файл `docs/diagrams/class-diagram.puml`

Показывает структуру классов обеих подсистем (сервер и клиент) и связи между ними.

### 8.3 Диаграмма последовательности
См. файл `docs/diagrams/sequence-diagram.puml`

Демонстрирует полный цикл успешного вызова от подключения до завершения разговора.

---

## 9. Особенности реализации

### 9.1 Многопоточность
- Каждое клиентское подключение обрабатывается в отдельном потоке
- Используется `async/await` для асинхронных операций ввода-вывода
- Доступ к общим ресурсам (списки абонентов и соединений) защищён блокировками (`lock`)

### 9.2 Обработка ошибок
- Все сетевые операции обёрнуты в `try-catch` блоки
- При разрыве соединения клиент автоматически отключается
- Ошибки логируются в консоль сервера
- Клиент получает уведомления об ошибках через событие `OnError`

### 9.3 Обновление UI
- Все обновления интерфейса в WPF клиенте выполняются через `Dispatcher.Invoke()`
- Это необходимо, так как события приходят из фоновых потоков

### 9.4 Broadcast обновлений
- После каждого изменения состояния любого абонента сервер рассылает обновлённый список всем клиентам
- Это позволяет всем абонентам видеть актуальное состояние сети в реальном времени

---

## 10. Возможные улучшения

1. **Аутентификация** — добавить логин/пароль для абонентов
2. **История вызовов** — сохранение истории звонков и сообщений
3. **Групповые вызовы** — поддержка конференц-связи
4. **Голосовая связь** — передача аудио вместо текстовых сообщений
5. **Веб-интерфейс** — создание веб-версии клиента
6. **База данных** — сохранение состояния системы в БД
7. **Шифрование** — защита передаваемых данных
8. **Переподключение** — автоматическое переподключение при разрыве связи
9. **Статистика** — сбор и отображение статистики использования
10. **Тестирование** — добавление unit и integration тестов

---

## 11. Заключение

Система АТС демонстрирует основные принципы построения клиент-серверных приложений с использованием TCP сокетов. Реализация включает управление состояниями, обработку событий, многопоточность и синхронизацию данных между множеством клиентов.

Проект может служить основой для более сложных систем коммуникации или учебным материалом для изучения сетевого программирования на C#.
