@startuml Диаграмма последовательности - Успешный вызов

actor "Абонент A" as ClientA
participant "Клиент A\n(PhoneClient)" as PhoneA
participant "Сервер\n(ATS)" as Server
participant "Клиент B\n(PhoneClient)" as PhoneB
actor "Абонент B" as ClientB

== Подключение ==
ClientA -> PhoneA: Подключиться
PhoneA -> Server: CONNECT
Server -> PhoneA: ASSIGNED:001
PhoneA -> ClientA: Показать номер 001

ClientB -> PhoneB: Подключиться
PhoneB -> Server: CONNECT
Server -> PhoneB: ASSIGNED:002
PhoneB -> ClientB: Показать номер 002

Server -> PhoneA: SUBSCRIBERS:[001, 002]
Server -> PhoneB: SUBSCRIBERS:[001, 002]

== Инициация вызова ==
ClientA -> PhoneA: Снять трубку
PhoneA -> Server: PICKUP
Server -> Server: Проверить лимит соединений
Server -> PhoneA: SIGNAL:готов
Server -> PhoneA: STATE:Готов
PhoneA -> ClientA: Отобразить состояние "Готов"

ClientA -> PhoneA: Набрать 002 и позвонить
PhoneA -> Server: DIAL:002
Server -> Server: Проверить существование\nи доступность абонента 002
Server -> PhoneA: STATE:Набор номера
Server -> PhoneB: INCOMING_CALL:001
Server -> PhoneB: STATE:Входящий вызов
PhoneB -> ClientB: MessageBox "Входящий вызов от 001"

Server -> PhoneA: SUBSCRIBERS:[001:Набор номера, 002:Входящий вызов]
Server -> PhoneB: SUBSCRIBERS:[001:Набор номера, 002:Входящий вызов]

== Установление соединения ==
ClientB -> PhoneB: Снять трубку
PhoneB -> Server: PICKUP
Server -> Server: Создать соединение\n001 <-> 002
Server -> PhoneA: CALL_CONNECTED
Server -> PhoneA: STATE:В разговоре
PhoneA -> ClientA: Активировать чат

Server -> PhoneB: CALL_CONNECTED
Server -> PhoneB: STATE:В разговоре
PhoneB -> ClientB: Активировать чат

Server -> PhoneA: SUBSCRIBERS:[001:В разговоре, 002:В разговоре]
Server -> PhoneB: SUBSCRIBERS:[001:В разговоре, 002:В разговоре]

== Обмен сообщениями ==
ClientA -> PhoneA: Ввести "Привет" и отправить
PhoneA -> PhoneA: Отобразить "Я: Привет"
PhoneA -> Server: MESSAGE:Привет
Server -> PhoneB: MESSAGE:Привет
PhoneB -> ClientB: Отобразить "Собеседник: Привет"

ClientB -> PhoneB: Ввести "Привет!" и отправить
PhoneB -> PhoneB: Отобразить "Я: Привет!"
PhoneB -> Server: MESSAGE:Привет!
Server -> PhoneA: MESSAGE:Привет!
PhoneA -> ClientA: Отобразить "Собеседник: Привет!"

== Завершение вызова ==
ClientA -> PhoneA: Положить трубку
PhoneA -> Server: HANGUP
Server -> Server: Разорвать соединение\n001 <-> 002
Server -> PhoneA: CALL_ENDED
Server -> PhoneA: STATE:Ожидание
PhoneA -> ClientA: Очистить чат,\nдеактивировать поле ввода

Server -> PhoneB: CALL_ENDED
Server -> PhoneB: STATE:Ожидание
PhoneB -> ClientB: Очистить чат,\nдеактивировать поле ввода

Server -> PhoneA: SUBSCRIBERS:[001:Ожидание, 002:Ожидание]
Server -> PhoneB: SUBSCRIBERS:[001:Ожидание, 002:Ожидание]

@enduml
